---
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - beszel_domain is defined
      - beszel_admin_email is defined
      - deploy_user is defined
    fail_msg: "CRITICAL: Required variables missing for Beszel"
  tags: [beszel, check]

- name: Ensure Docker network exists
  community.docker.docker_network:
    name: "{{ beszel_network }}"
    state: present
  become: true
  become_user: "{{ deploy_user }}"
  tags: [beszel, network]

# 1. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð°Ð¿Ð¾Ðº
- name: Ensure Beszel directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0755"
  loop:
    - "{{ beszel_root }}"
    - "{{ beszel_hub_data }}"
  tags: [beszel, deploy]

# 2. Ð ÐµÐ½Ð´ÐµÑ€Ð¸Ð½Ð³ Compose
- name: Render docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ beszel_root }}/docker-compose.yml"
    mode: "0640"
    owner: "{{ deploy_user }}"
    group: docker
  tags: [beszel, deploy]

# 3. Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð¡Ñ‚ÐµÐºÐ° (Hub + Agent)
- name: Deploy Beszel Stack
  community.docker.docker_compose_v2:
    project_src: "{{ beszel_root }}"
    state: present
    pull: always
    remove_orphans: true
  become: true
  become_user: "{{ deploy_user }}"
  tags: [beszel, deploy]

# 4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ
- name: Wait for Beszel Hub container to be running
  community.docker.docker_container_info:
    name: "{{ beszel_hub_container }}"
  register: beszel_hub_info
  until:
    - beszel_hub_info.exists
    - beszel_hub_info.container is defined
    - beszel_hub_info.container.State.Status == "running"
  retries: 5
  delay: 3
  changed_when: false
  tags: [beszel, deploy]

# ==============================================================================
# ðŸ¤– SELF-CONTAINED OIDC SETUP FOR BESZEL
# ==============================================================================

- name: "âš¡ AUTO-CONFIG: Generate PocketID Token"
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      if docker ps | grep -q pocketid; then
        LINK_OUTPUT=$(docker exec pocketid /app/pocket-id one-time-access-token {{ beszel_lldap_admin_dn }})
        echo "$LINK_OUTPUT" | grep -o 'https://[^ ]*' | awk -F/ '{print $NF}'
      else
        echo ""
      fi
    executable: /bin/bash
  register: beszel_pocketid_token_gen
  when: beszel_client_id | length == 0
  failed_when: false
  changed_when: false
  tags: [beszel, config, oidc]

- name: "âš¡ AUTO-CONFIG: Create Beszel Client in PocketID"
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      TOKEN="{{ beszel_pocketid_token_gen.stdout }}"
      if [ -z "$TOKEN" ]; then echo "SKIP: No Token"; exit 0; fi
      rm -f /tmp/beszel_pocket_cookie.txt
      curl -s -k -c /tmp/beszel_pocket_cookie.txt -X POST "https://{{ beszel_identity_domain }}/api/one-time-access-token/$TOKEN" > /dev/null
      RESP=$(curl -s -k -b /tmp/beszel_pocket_cookie.txt \
        -X POST "https://{{ beszel_identity_domain }}/api/oidc/clients" \
        -H "Content-Type: application/json" \
        -d '{
          "name": "Beszel Monitor",
          "launchUrl": "https://{{ beszel_domain }}",
          "callbackUrls": ["https://{{ beszel_domain }}/api/oauth2-redirect"],
          "pkceEnabled": true,
          "isPublic": false
        }')
      ID=$(echo "$RESP" | jq -r '.id // empty')
      SECRET=$(echo "$RESP" | jq -r '.credentials.secret // .clientSecret // empty')
      if [ -n "$ID" ] && [ -z "$SECRET" ]; then
          S_RESP=$(curl -s -k -b /tmp/beszel_pocket_cookie.txt \
            -X POST "https://{{ beszel_identity_domain }}/api/oidc/clients/$ID/secret" \
            -H "Content-Type: application/json")
          SECRET=$(echo "$S_RESP" | jq -r '.secret // empty')
      fi
      if [ -n "$ID" ] && [ -n "$SECRET" ]; then
         echo "BZ_ID:$ID"
         echo "BZ_SECRET:$SECRET"
      fi
      rm -f /tmp/beszel_pocket_cookie.txt
    executable: /bin/bash
  when: beszel_client_id | length == 0
  register: beszel_oidc_client
  changed_when: "'BZ_ID:' in beszel_oidc_client.stdout"
  tags: [beszel, config, oidc]

- name: Set Beszel OIDC Facts
  ansible.builtin.set_fact:
    beszel_final_client_id: >-
      {{ (beszel_oidc_client.stdout | default('') | regex_search('BZ_ID:([a-zA-Z0-9-]+)', '\1') | first)
      if (beszel_oidc_client.changed and 'BZ_ID:' in beszel_oidc_client.stdout)
      else beszel_client_id }}
    beszel_final_client_secret: >-
      {{ (beszel_oidc_client.stdout | default('') | regex_search('BZ_SECRET:([a-zA-Z0-9-]+)', '\1') | first)
      if (beszel_oidc_client.changed and 'BZ_SECRET:' in beszel_oidc_client.stdout)
      else beszel_client_secret }}
  tags: [beszel, config, oidc]

- name: "âš¡ AUTO-CONFIG: Patch Beszel OIDC Settings"
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      TOKEN=$(curl -s -X POST "https://{{ beszel_domain }}/api/collections/_superusers/auth-with-password" \
        -H "Content-Type: application/json" \
        -d '{"identity":"{{ beszel_admin_email }}","password":"{{ beszel_admin_password }}"}' | jq -r '.token')
      if [ -z "$TOKEN" ] || [ "$TOKEN" == "null" ]; then echo "FAIL: Login"; exit 1; fi
      curl -X PATCH "https://{{ beszel_domain }}/api/collections/users" \
        -H "Authorization: $TOKEN" \
        -H "Content-Type: application/json" \
        -d "{
          \"oauth2\": {
            \"enabled\": true,
            \"providers\": [
              {
                \"name\": \"oidc\",
                \"title\": \"PocketID\",
                \"clientId\": \"{{ beszel_final_client_id }}\",
                \"clientSecret\": \"{{ beszel_final_client_secret }}\",
                \"authUrl\": \"https://{{ beszel_identity_domain }}/authorize\",
                \"tokenUrl\": \"https://{{ beszel_identity_domain }}/api/oidc/token\",
                \"userInfoUrl\": \"https://{{ beszel_identity_domain }}/api/oidc/userinfo\",
                \"displayName\": \"PocketID\",
                \"pkce\": true
              }
            ]
          }
        }"
    executable: /bin/bash
  when:
    - beszel_admin_email | length > 0
    - beszel_final_client_id | length > 0
    - beszel_final_client_secret | length > 0
  register: beszel_patch_result
  changed_when: beszel_patch_result.rc == 0
  tags: [beszel, config, oidc]

- name: "âš¡ AUTO-CONFIG: Fetch Beszel Secrets (User Context)"
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      ADM_TOK=$(curl -s -X POST "https://{{ beszel_domain }}/api/collections/_superusers/auth-with-password" \
        -H "Content-Type: application/json" \
        -d '{"identity":"{{ beszel_admin_email }}","password":"{{ beszel_admin_password }}"}' | jq -r '.token')
      KEY_RESP=$(curl -s "https://{{ beszel_domain }}/api/beszel/getkey" -H "Authorization: $ADM_TOK")
      PUB_KEY=$(echo "$KEY_RESP" | jq -r '.key // empty')
      USER_TOK=$(curl -s -X POST "https://{{ beszel_domain }}/api/collections/users/auth-with-password" \
        -H "Content-Type: application/json" \
        -d '{"identity":"{{ beszel_admin_email }}","password":"{{ beszel_admin_password }}"}' | jq -r '.token')
      if [ -z "$USER_TOK" ] || [ "$USER_TOK" == "null" ]; then USER_TOK=$ADM_TOK; fi
      TOK_RESP=$(curl -s "https://{{ beszel_domain }}/api/beszel/universal-token?enable=1" -H "Authorization: $USER_TOK")
      UNIV_TOKEN=$(echo "$TOK_RESP" | jq -r '.token // empty')
      echo "KEY:$PUB_KEY"
      echo "TOKEN:$UNIV_TOKEN"
    executable: /bin/bash
  register: beszel_secrets
  changed_when: false
  tags: [beszel, config, agent]

- name: Set Beszel Agent Facts
  ansible.builtin.set_fact:
    beszel_dynamic_key: >-
      {{ beszel_secrets.stdout | regex_search('KEY:(ssh-ed25519 [^\s]+)', '\1') | first | default(beszel_agent_key) }}
    beszel_dynamic_token: >-
      {{ beszel_secrets.stdout | regex_search('TOKEN:([a-f0-9-]+)', '\1') | first }}
  tags: [beszel, config]

# 5. ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Compose Ñ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼Ð¸ ÑÐµÐºÑ€ÐµÑ‚Ð°Ð¼Ð¸
- name: Update Docker Compose with Dynamic Secrets
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ beszel_root }}/docker-compose.yml"
    mode: '0640'
    owner: "{{ deploy_user }}"
    group: docker
  register: beszel_compose_update
  tags: [beszel, config]

- name: Restart Beszel to apply Secrets
  community.docker.docker_compose_v2:
    project_src: "{{ beszel_root }}"
    state: present
    pull: never
  when: beszel_compose_update.changed or beszel_secrets.stdout | length > 0
  tags: [beszel, config]

- name: Show Post-Install Instructions & Secrets
  ansible.builtin.debug:
    msg:
      - "ðŸš€ Beszel Hub deployed at https://{{ beszel_domain }}"
      - "âœ… Active Agent Configured & Registered (User Context)"
      - "---------------------------------------------------"
      - "Dynamic Key:   {{ beszel_dynamic_key }}"
      - "Dynamic Token: {{ beszel_dynamic_token }}"
      - "---------------------------------------------------"
  tags: [beszel, info]
