---
- name: Validate required Identity secrets (Basic checks)
  ansible.builtin.assert:
    that:
      - vault_identity.lldap.admin_password is defined
      - vault_identity.lldap.key_seed is defined
    fail_msg: "CRITICAL: Missing basic Vault secrets for LLDAP!"
  tags: [deploy, identity, check]

# 1. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–æ–∫
- name: Ensure Identity directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ default_puid | default('1000') }}"
    group: "{{ default_pgid | default('1000') }}"
    mode: "0755"
  loop:
    - "{{ identity_compose_dir }}"
    - "{{ identity_data_dir }}/lldap"
    - "{{ identity_data_dir }}/pocketid/data"
    - "{{ identity_data_dir }}/tinyauth"

# 2. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ Compose
- name: Render docker-compose.yml (Initial)
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ identity_compose_dir }}/docker-compose.yml"
    mode: "0640"
    owner: "{{ deploy_user }}"
    group: docker

# 3. –ó–∞–ø—É—Å–∫ –°—Ç–µ–∫–∞
- name: Deploy Identity Stack
  community.docker.docker_compose_v2:
    project_src: "{{ identity_compose_dir }}"
    state: present
    pull: always
    remove_orphans: true
  become: true  # <--- –î–û–ë–ê–í–õ–ï–ù–û
  become_user: "{{ deploy_user }}"
  tags: [deploy, identity]

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è LLDAP
- name: Wait for LLDAP container to be healthy
  ansible.builtin.command:
    cmd: docker inspect --format='{{ '{{' }}.State.Health.Status{{ '}}' }}' lldap
  register: identity_lldap_health
  retries: 30
  delay: 2
  until: identity_lldap_health.stdout == 'healthy'
  changed_when: false
  tags: [deploy, identity, bootstrap]

# 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LLDAP (Bootstrap Admin)
- name: Bootstrap LLDAP admin attributes
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      docker exec lldap sh -c '
        TOKEN=$(wget -qO- \
          --post-data="{\"username\":\"{{ identity_lldap_admin_dn }}\",\"password\":\"{{ identity_lldap_admin_pass }}\"}" \
          --header="Content-Type: application/json" \
          http://127.0.0.1:{{ identity_lldap_port_http }}/auth/simple/login \
          | grep -o "\"token\":\"[^\"]*" | cut -d"\"" -f4)

        [ -z "$TOKEN" ] && echo "ERROR: Failed to get JWT token" && exit 1

        MUTATION="mutation{updateUser(user:{id:\\\"{{ identity_lldap_admin_dn }}\\\", \
          firstName:\\\"{{ identity_lldap_admin_dn | capitalize }}\\\", \
          email:\\\"{{ identity_lldap_admin_email }}\\\"}){ok}}"

        RESULT=$(wget -qO- \
          --post-data="{\"query\":\"$MUTATION\"}" \
          --header="Content-Type: application/json" \
          --header="Authorization: Bearer $TOKEN" \
          http://127.0.0.1:{{ identity_lldap_port_http }}/api/graphql)

        echo "$RESULT"
        echo "$RESULT" | grep -q "\"ok\":true"
      '
    executable: /bin/bash
  register: identity_lldap_bootstrap
  changed_when: identity_lldap_bootstrap.rc == 0
  failed_when: identity_lldap_bootstrap.rc != 0
  no_log: false
  # –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∞—Ç—Ç—Ä–∏–±—É—Ç–æ–≤ –∞–¥–º–∏–Ω–∞ —Å—Ç–æ–∏—Ç –ø–Ω—É—Ç—å PocketID, —á—Ç–æ–±—ã –æ–Ω –ø–µ—Ä–µ—á–∏—Ç–∞–ª LDAP
  notify: Restart PocketID for LDAP sync
  tags: [deploy, identity, bootstrap]

- name: Flush handlers to restart PocketID immediately
  ansible.builtin.meta: flush_handlers
  tags: [deploy, identity, bootstrap]

- name: Wait for PocketID LDAP sync to complete
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      docker logs pocketid --tail 100 | grep -q "Job run successfully.*name=SyncLdap"
    executable: /bin/bash
  register: identity_pocketid_sync_check
  retries: 30
  delay: 2
  until: identity_pocketid_sync_check.rc == 0
  changed_when: false
  tags: [deploy, identity, bootstrap]

# 6. –ú–∞–≥–∏—è –∞–≤—Ç–æ-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ OIDC (PocketID -> TinyAuth)
- name: "‚ö° AUTO-SETUP: Setup API Key & OIDC Client via One-Time Token"
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫—É–∫—É
      rm -f /tmp/pocket_cookie.txt
      sleep 5

      # 1. –°—Å—ã–ª–∫–∞ –≤—Ö–æ–¥–∞
      LINK_OUTPUT=$(docker exec pocketid /app/pocket-id one-time-access-token {{ identity_lldap_admin_dn }})
      TOKEN=$(echo "$LINK_OUTPUT" | grep -o 'https://[^ ]*' | awk -F/ '{print $NF}')
      if [ -z "$TOKEN" ]; then echo "FAIL: No Token"; exit 1; fi

      # 2. –õ–æ–≥–∏–Ω -> Cookie
      for i in {1..5}; do
        curl -s -k -c /tmp/pocket_cookie.txt -X POST "https://{{ identity_pocketid_domain }}/api/one-time-access-token/$TOKEN" > /dev/null
        if grep -q "__Host-access_token" /tmp/pocket_cookie.txt; then break; fi
        sleep 2
      done

      if ! grep -q "__Host-access_token" /tmp/pocket_cookie.txt; then
         echo "WARN: Cookie not found. Login failed?"
         exit 0
      fi

      # 3. API Key (—á–µ—Ä–µ–∑ Cookie)
      EXPIRE_DATE="2035-01-01T00:00:00Z"
      API_KEY_RESP=$(curl -s -k -b /tmp/pocket_cookie.txt \
        -X POST "https://{{ identity_pocketid_domain }}/api/api-keys" \
        -H "Content-Type: application/json" \
        -d "{\"name\":\"Ansible Auto Key\",\"description\":\"Automated\",\"expiresAt\":\"$EXPIRE_DATE\"}")
      API_TOKEN=$(echo "$API_KEY_RESP" | jq -r '.token // empty')

      # 4. OIDC Client (—á–µ—Ä–µ–∑ Cookie)
      OIDC_RESP=$(curl -s -k -b /tmp/pocket_cookie.txt \
        -X POST "https://{{ identity_pocketid_domain }}/api/oidc/clients" \
        -H "Content-Type: application/json" \
        -d '{
          "name": "TinyAuth",
          "launchUrl": "https://{{ identity_tinyauth_domain }}",
          "callbackUrls": ["https://{{ identity_tinyauth_domain }}/api/oauth/callback/pocketid"],
          "pkceEnabled": true,
          "isPublic": false
        }')
      CLIENT_ID=$(echo "$OIDC_RESP" | jq -r '.id // empty')

      if [ -z "$CLIENT_ID" ]; then
         echo "INFO: Failed to create client."
         exit 0
      fi

      # 5. –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–ï–ö–†–ï–¢–ê (–µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç)
      CLIENT_SECRET=$(echo "$OIDC_RESP" | jq -r '.credentials.secret // .clientSecret // empty')

      if [ -z "$CLIENT_SECRET" ]; then
          # –ï—Å–ª–∏ —Å–µ–∫—Ä–µ—Ç–∞ –Ω–µ—Ç ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π!
          SECRET_RESP=$(curl -s -k -b /tmp/pocket_cookie.txt \
            -X POST "https://{{ identity_pocketid_domain }}/api/oidc/clients/$CLIENT_ID/secret" \
            -H "Content-Type: application/json")
          # –ü–∞—Ä—Å–∏–º —Å–µ–∫—Ä–µ—Ç –∏–∑ –æ—Ç–≤–µ—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
          CLIENT_SECRET=$(echo "$SECRET_RESP" | jq -r '.secret // empty')
      fi

      if [ -n "$CLIENT_ID" ] && [ -n "$CLIENT_SECRET" ]; then
        echo "ID:$CLIENT_ID"
        echo "SECRET:$CLIENT_SECRET"
        if [ -n "$API_TOKEN" ]; then echo "TOKEN:$API_TOKEN"; fi
      else
        echo "INFO: Client created but SECRET is still missing. Weird."
      fi
    executable: /bin/bash
  register: identity_auto_oidc_setup
  failed_when: false
  changed_when: "'SECRET:' in identity_auto_oidc_setup.stdout"
  tags: [deploy, identity, bootstrap, magic]

- name: Set Dynamic OIDC Facts
  ansible.builtin.set_fact:
    identity_tinyauth_dynamic_id: "{{ identity_auto_oidc_setup.stdout | regex_search('ID:([a-zA-Z0-9-]+)', '\\1') | first }}"
    identity_tinyauth_dynamic_secret: "{{ identity_auto_oidc_setup.stdout | regex_search('SECRET:([a-zA-Z0-9-]+)', '\\1') | first }}"
    identity_pocketid_auto_api_key: "{{ identity_auto_oidc_setup.stdout | regex_search('TOKEN:([a-zA-Z0-9_]+)', '\\1') | first | default('NotCreated') }}"
  when:
    - identity_auto_oidc_setup.rc == 0
    - "'SECRET:' in identity_auto_oidc_setup.stdout"
  tags: [deploy, identity, bootstrap, magic]

- name: Show Generated Secrets (SAVE TO VAULT!)
  ansible.builtin.debug:
    msg:
      - "üéâ ULTRA-AUTOMATION SUCCESS!"
      - "TinyAuth Client ID: {{ identity_tinyauth_dynamic_id }}"
      - "TinyAuth Secret: {{ identity_tinyauth_dynamic_secret }}"
      - "PocketID API Key: {{ identity_pocketid_auto_api_key }}"
      - "‚ö†Ô∏è  TinyAuth is being re-deployed with these credentials NOW."
      - "‚ö†Ô∏è  PLEASE COPY THESE TO vault.yml FOR FUTURE RUNS!"
  when: identity_tinyauth_dynamic_secret is defined
  tags: [deploy, identity, bootstrap, magic]

# 7. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ TinyAuth (–µ—Å–ª–∏ —Å–µ–∫—Ä–µ—Ç—ã –ø–æ–º–µ–Ω—è–ª–∏—Å—å)
- name: Re-render docker-compose.yml with new secrets
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ identity_compose_dir }}/docker-compose.yml"
    mode: "0640"
    owner: "{{ deploy_user }}"
    group: docker
  when: identity_tinyauth_dynamic_secret is defined
  tags: [deploy, identity, bootstrap, magic]

- name: Re-deploy TinyAuth with new credentials (force recreate)
  community.docker.docker_compose_v2:
    project_src: "{{ identity_compose_dir }}"
    services:
      - tinyauth
    state: present
    recreate: always
  become: true
  become_user: "{{ deploy_user }}"
  when: identity_tinyauth_dynamic_secret is defined
  tags: [deploy, identity, bootstrap, magic]

# 8. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞
- name: Generate Fresh One-Time Login Link for Admin
  ansible.builtin.command:
    cmd: docker exec pocketid /app/pocket-id one-time-access-token {{ identity_lldap_admin_dn }}
  register: identity_login_link
  changed_when: false
  tags: [deploy, identity, token]

- name: Display PocketID Login Link
  ansible.builtin.debug:
    msg:
      - "üîê Login to PocketID Admin Console:"
      - "{{ identity_login_link.stdout }}"
      - "This link is valid for one-time use only."
  tags: [deploy, identity, token]
