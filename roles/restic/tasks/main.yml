# roles/restic/tasks/main.yml
---
- name: Deploy Restic Worker Container
  ansible.builtin.include_role:
    name: utils
    tasks_from: docker_service
  vars:
    utils_docker_service_name: "{{ restic_service_name }}"
    utils_docker_service_dir: "{{ restic_compose_dir }}"
    utils_docker_service_compose_template: "{{ playbook_dir }}/roles/restic/templates/docker-compose.yml.j2"

    # Не пулим (т.к. локальный) и не стартуем (т.к. worker)
    utils_docker_service_pull_images: false
    utils_docker_service_start: false

    # Доп. папка для сборки
    utils_docker_service_data_dirs:
      - "{{ restic_compose_dir }}/build"

    # Файлы: Dockerfile и Config
    utils_docker_service_files:
      - dest: "{{ restic_compose_dir }}/build/Dockerfile"
        content: |
          FROM restic/restic:latest
          RUN apk add --no-cache rclone ca-certificates
        mode: "0644"

      # Секретный конфиг
      - dest: "{{ restic_compose_dir }}/config/rclone.conf"
        content: "{{ restic_rclone_config }}"
        mode: "0600"
        owner: root
        group: root
        # ВАЖНО: Скрываем этот файл из логов
        no_log: true

    # Шаблоны: Entrypoint
    utils_docker_service_templates:
      - src: entrypoint.sh.j2
        dest: "{{ restic_compose_dir }}/entrypoint.sh"
        mode: "0755"

    # СБОРКА ОБРАЗА
    # Utils соберет его сразу после создания файлов
    utils_docker_service_build:
      name: "{{ restic_image }}"
      path: "{{ restic_compose_dir }}/build"
      pull: true
      force: false

# --- Специфичная логика Restic ---

# Инициализация контейнера (create only)
- name: Create Restic container (initialized but stopped)
  ansible.builtin.command:
    cmd: docker compose up --no-start --remove-orphans
    chdir: "{{ restic_compose_dir }}"
  register: restic_create_container
  changed_when:
    - "'Created' in restic_create_container.stderr or 'Recreated' in restic_create_container.stderr"

# Systemd Units
- name: Deploy Systemd Units
  ansible.builtin.template:
    src: "{{ item }}"
    dest: "/etc/systemd/system/{{ item | regex_replace('.j2$', '') }}"
    mode: '0644'
  loop:
    - restic-backup.service.j2
    - restic-backup.timer.j2
    - restic-check.service.j2
    - restic-check.timer.j2
  notify: Reload systemd

- name: Enable and Start Timers
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: started
    enabled: true
  loop:
    - restic-backup.timer
    - restic-check.timer

# Уборка старого
- name: Cleanup old rclone.conf
  ansible.builtin.file:
    path: "{{ restic_compose_dir }}/rclone.conf"
    state: absent
