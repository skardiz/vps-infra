# roles/utils/tasks/docker_service.yml
---
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - utils_docker_service_name is defined
      - utils_docker_service_dir is defined
      - utils_docker_service_compose_template is defined
    fail_msg: "Missing required variables for {{ utils_docker_service_name | default('service') }}"
    quiet: true

# --- Создаем базовую структуру (Root, Config, Data) ---
- name: Create service structure for {{ utils_docker_service_name }}
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ utils_docker_service_owner | default(deploy_user) }}"
    group: "{{ utils_docker_service_group | default(deploy_user) }}"
    mode: "0755"
  loop: "{{
      [
        utils_docker_service_dir,
        utils_docker_service_dir ~ '/config',
        utils_docker_service_dir ~ '/data'
      ] + (utils_docker_service_data_dirs | default([]))
    }}"
  become: true

- name: Create specific files for {{ utils_docker_service_name }}
  ansible.builtin.copy:
    dest: "{{ item.dest }}"
    content: "{{ item.content | default('') }}"
    mode: "{{ item.mode | default('0644') }}"
    owner: "{{ item.owner | default(deploy_user) }}"
    group: "{{ item.group | default(deploy_user) }}"
    force: "{{ item.force | default(true) }}"
  loop: "{{ utils_docker_service_files | default([]) }}"
  loop_control:
    label: "{{ item.dest | basename }}"
  # Безопасность: скрываем содержимое секретных файлов
  no_log: "{{ item.no_log | default(false) }}"
  become: true
  when: utils_docker_service_files | default([]) | length > 0
  register: utils_files_result

- name: Render config templates for {{ utils_docker_service_name }}
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode | default('0644') }}"
    owner: "{{ item.owner | default(deploy_user) }}"
    group: "{{ item.group | default(deploy_user) }}"
  loop: "{{ utils_docker_service_templates | default([]) }}"
  loop_control:
    label: "{{ item.dest | basename }}"
  become: true
  when: utils_docker_service_templates | default([]) | length > 0
  register: utils_templates_result

# --- Сборка локального образа (Опционально) ---
- name: Build local Docker image for {{ utils_docker_service_name }}
  community.docker.docker_image:
    name: "{{ utils_docker_service_build.name }}"
    source: build
    build:
      path: "{{ utils_docker_service_build.path }}"
      pull: "{{ utils_docker_service_build.pull | default(true) }}"
      dockerfile: "{{ utils_docker_service_build.dockerfile | default(omit) }}"
      args: "{{ utils_docker_service_build.args | default(omit) }}"
    # Умная пересборка: если файлы или шаблоны изменились, пересобираем
    force_source: >-
      {{
        utils_docker_service_build.force | default(false)
        or (utils_files_result is changed)
        or (utils_templates_result is changed)
      }}
  become: true
  when: utils_docker_service_build is defined

- name: Configure UFW for {{ utils_docker_service_name }}
  community.general.ufw:
    rule: allow
    port: "{{ item.port }}"
    proto: "{{ item.proto | default('tcp') }}"
    comment: "{{ item.comment | default(utils_docker_service_name) }}"
  loop: "{{ utils_docker_service_ports | default([]) }}"
  loop_control:
    label: "Port {{ item.port }}/{{ item.proto | default('tcp') }}"
  become: true
  when: utils_docker_service_ports | default([]) | length > 0

- name: Render docker-compose.yml for {{ utils_docker_service_name }}
  ansible.builtin.template:
    src: "{{ utils_docker_service_compose_template }}"
    dest: "{{ utils_docker_service_dir }}/docker-compose.yml"
    mode: "0640"
    owner: "{{ deploy_user }}"
    group: docker
  become: true
  register: utils_compose_rendered

- name: Pull images for {{ utils_docker_service_name }}
  community.docker.docker_compose_v2_pull:
    project_src: "{{ utils_docker_service_dir }}"
  become: true
  become_user: "{{ deploy_user }}"
  when:
    - utils_docker_service_pull_images | default(true)
    - utils_compose_rendered.changed or (utils_docker_service_force_pull | default(false))
  tags: [pull]

- name: Deploy stack for {{ utils_docker_service_name }}
  community.docker.docker_compose_v2:
    project_src: "{{ utils_docker_service_dir }}"
    state: present
    remove_orphans: true
    wait: "{{ utils_docker_service_wait | default(true) }}"
    wait_timeout: "{{ utils_docker_service_wait_timeout | default(120) }}"
  become: true
  become_user: "{{ deploy_user }}"
  when: utils_docker_service_start | default(true)
  register: utils_compose_result
