services:
  {{ vaultwarden_service_name }}:
    image: {{ vaultwarden_image }}
    container_name: {{ vaultwarden_service_name }}
    restart: unless-stopped

    deploy:
      resources:
        limits:
          memory: {{ vaultwarden_memory_limit }}

    volumes:
      - ./data:/data

    networks:
      - {{ vaultwarden_docker_network }}

    environment:
      - DOMAIN=https://{{ vaultwarden_domain }}
      - SIGNUPS_ALLOWED={{ vaultwarden_signups_allowed | lower }}
      - INVITATIONS_ALLOWED={{ vaultwarden_invitations_allowed | lower }}
      - SHOW_PASSWORD_HINT={{ vaultwarden_show_password_hint | lower }}
      - WEBSOCKET_ENABLED={{ vaultwarden_websocket_enabled | lower }}
      - LOG_LEVEL={{ vaultwarden_log_level }}
      - ADMIN_TOKEN={{ vaultwarden_admin_token }}

    # üî• HEALTHCHECK
    healthcheck:
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞
      test: ["CMD", "curl", "-f", "http://localhost:80/alive"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    labels:
      traefik.enable: "true"
      traefik.docker.network: "{{ vaultwarden_docker_network }}"

      # --- Main Router ---
      traefik.http.routers.{{ vaultwarden_service_name }}.rule: "Host(`{{ vaultwarden_domain }}`)"
      traefik.http.routers.{{ vaultwarden_service_name }}.entrypoints: "{{ vaultwarden_traefik_entrypoint }}"
      traefik.http.routers.{{ vaultwarden_service_name }}.tls: "true"
      traefik.http.routers.{{ vaultwarden_service_name }}.tls.certresolver: "{{ vaultwarden_traefik_certresolver }}"
      traefik.http.routers.{{ vaultwarden_service_name }}.service: "{{ vaultwarden_service_name }}"
      traefik.http.routers.{{ vaultwarden_service_name }}.middlewares: "geoblock-strict@file"
      traefik.http.services.{{ vaultwarden_service_name }}.loadbalancer.server.port: "{{ vaultwarden_port_http }}"

      # --- WebSocket Router ---
      traefik.http.routers.{{ vaultwarden_service_name }}-ws.rule: "Host(`{{ vaultwarden_domain }}`) && Path(`/notifications/hub`)"
      traefik.http.routers.{{ vaultwarden_service_name }}-ws.entrypoints: "{{ vaultwarden_traefik_entrypoint }}"
      traefik.http.routers.{{ vaultwarden_service_name }}-ws.tls: "true"
      traefik.http.routers.{{ vaultwarden_service_name }}-ws.tls.certresolver: "{{ vaultwarden_traefik_certresolver }}"
      traefik.http.routers.{{ vaultwarden_service_name }}-ws.service: "{{ vaultwarden_service_name }}-ws"
      traefik.http.routers.{{ vaultwarden_service_name }}-ws.middlewares: "geoblock-strict@file"
      traefik.http.services.{{ vaultwarden_service_name }}-ws.loadbalancer.server.port: "{{ vaultwarden_port_ws }}"

      # Traefik Healthcheck (—á—Ç–æ–±—ã –¢—Ä–∞–µ—Ñ–∏–∫ –Ω–µ —Å–ª–∞–ª —Ç—Ä–∞—Ñ–∏–∫ –≤ –º–µ—Ä—Ç–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)
      traefik.http.services.{{ vaultwarden_service_name }}.loadbalancer.healthcheck.path: "/alive"
      traefik.http.services.{{ vaultwarden_service_name }}.loadbalancer.healthcheck.interval: "10s"
      traefik.http.services.{{ vaultwarden_service_name }}.loadbalancer.healthcheck.timeout: "5s"

networks:
  {{ vaultwarden_docker_network }}:
    external: true
